{% extends "base.html" %}

{% block title %}{{ obra.titol }} - {{ obra.autor }} | Editorial Clàssica{% endblock %}
{% block description %}{{ obra.descripcio|default('Traducció al català de ' ~ obra.titol ~ ' de ' ~ obra.autor) }}{% endblock %}

{% block og_title %}{{ obra.titol }} - {{ obra.autor }}{% endblock %}
{% block og_description %}{{ obra.descripcio|default('Traducció al català') }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_url %}/{{ obra.slug }}.html{% endblock %}

{% block head_extra %}
<!-- Estils per índex i navegació de capítols -->
<style>
    /* Separador en controls */
    .view-separator {
        color: var(--text-muted, #999);
        margin: 0 0.5rem;
    }

    /* Botó índex */
    .toc-toggle {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .toc-icon {
        font-size: 1.1em;
    }

    /* Panell índex */
    .chapter-toc {
        display: none;
        position: fixed;
        top: 80px;
        left: 0;
        width: 320px;
        max-width: 90vw;
        max-height: calc(100vh - 100px);
        background: var(--bg-primary, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 0 8px 8px 0;
        box-shadow: 4px 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow: hidden;
    }
    .chapter-toc.open {
        display: block;
        animation: slideIn 0.2s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .toc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        background: var(--bg-secondary, #f8f8f8);
    }
    .toc-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }
    .toc-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        color: var(--text-muted, #666);
    }
    .toc-close:hover {
        color: var(--text-primary, #333);
    }
    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
    }
    .toc-list li {
        border-bottom: 1px solid var(--border-light, #f0f0f0);
    }
    .toc-list li:last-child {
        border-bottom: none;
    }
    .toc-list a {
        display: block;
        padding: 0.75rem 1.25rem;
        color: var(--text-primary, #333);
        text-decoration: none;
        transition: background 0.15s;
    }
    .toc-list a:hover {
        background: var(--bg-hover, #f5f5f5);
    }
    .toc-list a.active {
        background: var(--accent-light, #fff8e1);
        border-left: 3px solid var(--accent, #D4AF37);
        font-weight: 500;
    }
    .toc-chapter-num {
        color: var(--text-muted, #888);
        margin-right: 0.5rem;
    }

    /* Navegació entre capítols */
    .chapter-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 0;
        margin-top: 2rem;
        border-top: 1px solid var(--border-color, #e0e0e0);
        gap: 1rem;
    }
    .chapter-nav-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: var(--bg-secondary, #f5f5f5);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        color: var(--text-primary, #333);
        transition: all 0.2s;
    }
    .chapter-nav-btn:hover:not(:disabled) {
        background: var(--accent, #D4AF37);
        color: white;
        border-color: var(--accent, #D4AF37);
    }
    .chapter-nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .nav-arrow {
        font-size: 1.2em;
    }
    .chapter-indicator {
        font-size: 0.9rem;
        color: var(--text-muted, #666);
        text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chapter-toc {
            width: 100%;
            max-width: 100%;
            border-radius: 0;
        }
        .chapter-nav {
            flex-wrap: wrap;
        }
        .chapter-nav-btn .nav-text {
            display: none;
        }
        .chapter-indicator {
            order: -1;
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }

    /* Mode fosc */
    [data-theme="dark"] .chapter-toc {
        background: #1e1e1e;
        border-color: #333;
    }
    [data-theme="dark"] .toc-header {
        background: #252525;
        border-color: #333;
    }
    [data-theme="dark"] .toc-list a.active {
        background: #2a2a1e;
    }
    [data-theme="dark"] .chapter-nav-btn {
        background: #252525;
        border-color: #444;
    }
</style>

<!-- Schema.org -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Book",
    "name": "{{ obra.titol }}",
    "author": {
        "@type": "Person",
        "name": "{{ obra.autor }}"
    },
    "translator": {
        "@type": "Organization",
        "name": "{{ obra.traductor|default('Editorial Clàssica') }}"
    },
    "inLanguage": "ca",
    "workTranslation": {
        "@type": "Book",
        "name": "{{ obra.titol_original }}",
        "author": {
            "@type": "Person",
            "name": "{{ obra.autor_original|default(obra.autor) }}"
        },
        "inLanguage": "{{ obra.llengua_original }}"
    },
    "datePublished": "{{ obra.any_traduccio }}"
}
</script>
{% endblock %}

{% block content %}
<article class="page-content">
    <div class="container">
        <!-- Capçalera de l'obra amb portada -->
        <header class="work-header">
            <div class="work-header-content" style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                {% if obra.portada_url %}
                <div class="work-cover" style="flex-shrink: 0;">
                    <img src="{{ base_url }}{{ obra.portada_url }}"
                         alt="Portada de {{ obra.titol }}"
                         style="max-width: 200px; height: auto; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                </div>
                {% endif %}

                <div class="work-info" style="flex: 1; min-width: 300px;">
                    <h1 class="work-title">{{ obra.titol }}</h1>
                    {% if obra.titol_original %}
                    <p class="work-title-original">{{ obra.titol_original }}</p>
                    {% endif %}

                    <div class="work-meta-grid">
                        <div class="work-meta-item">
                            <strong>Autor</strong>
                            {{ obra.autor }}
                            {% if obra.autor_original and obra.autor_original != obra.autor %}
                            <br><small>({{ obra.autor_original }})</small>
                            {% endif %}
                        </div>

                        <div class="work-meta-item">
                            <strong>Traducció</strong>
                            {{ obra.traductor|default('Biblioteca Arion') }}
                        </div>

                        <div class="work-meta-item">
                            <strong>Llengua original</strong>
                            {{ obra.llengua_original|capitalize }}
                        </div>

                        {% if obra.any_original %}
                        <div class="work-meta-item">
                            <strong>Data original</strong>
                            {{ obra.any_original }}
                        </div>
                        {% endif %}

                        {% if obra.estat %}
                        <div class="work-meta-item">
                            <strong>Estat</strong>
                            <span class="badge badge-status-{{ obra.estat }}">{{ obra.estat }}</span>
                        </div>
                        {% endif %}

                        {% if obra.qualitat %}
                        <div class="work-meta-item">
                            <strong>Qualitat</strong>
                            {{ obra.qualitat }}/10
                        </div>
                        {% endif %}
                    </div>

                    {% if obra.descripcio %}
                    <p class="work-description">{{ obra.descripcio }}</p>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Controls de vista -->
        <div class="text-container" data-mode="bilingue">
            <div class="view-controls">
                <button class="view-btn toc-toggle" id="toc-toggle" title="Índex de capítols">
                    <span class="toc-icon">☰</span> Índex
                </button>
                <span class="view-separator">|</span>
                <button class="view-btn" data-mode="original">Original</button>
                <button class="view-btn active" data-mode="bilingue">Bilingüe</button>
                <button class="view-btn" data-mode="traduccio">Traducció</button>
            </div>

            <!-- Índex de capítols (amagat per defecte) -->
            <nav class="chapter-toc" id="chapter-toc" aria-label="Índex de capítols">
                <div class="toc-header">
                    <h3>Índex de capítols</h3>
                    <button class="toc-close" id="toc-close" aria-label="Tancar índex">&times;</button>
                </div>
                <ol class="toc-list" id="toc-list">
                    <!-- Omplert dinàmicament per JS -->
                </ol>
            </nav>

            <!-- Grid bilingüe -->
            <div class="bilingue-grid">
                <!-- Columna original -->
                <section class="original-column">
                    <div class="column-header">Text original ({{ obra.llengua_original }})</div>
                    {{ contingut_original|safe }}
                </section>

                <!-- Columna traducció -->
                <section class="translation-column">
                    <div class="column-header">Traducció (català)</div>
                    {{ contingut_traduccio|safe }}
                </section>
            </div>

            <!-- Navegació entre capítols -->
            <nav class="chapter-nav" id="chapter-nav" aria-label="Navegació entre capítols">
                <button class="chapter-nav-btn" id="prev-chapter" disabled>
                    <span class="nav-arrow">←</span>
                    <span class="nav-text">Capítol anterior</span>
                </button>
                <span class="chapter-indicator" id="chapter-indicator">Capítol 1 de 1</span>
                <button class="chapter-nav-btn" id="next-chapter" disabled>
                    <span class="nav-text">Capítol següent</span>
                    <span class="nav-arrow">→</span>
                </button>
            </nav>
        </div>

        <!-- Notes -->
        {% if notes %}
        <section class="notes-section" id="notes">
            <h2>Notes</h2>
            {% for nota in notes %}
            <div class="note" id="nota-{{ nota.id }}">
                <div class="note-header">
                    <span class="note-number">[{{ nota.id }}]</span>
                    {% if nota.titol %}
                    <h4>{{ nota.titol }}</h4>
                    {% endif %}
                </div>
                {{ nota.contingut|safe }}
                {% if nota.refs %}
                <p class="note-refs">{{ nota.refs }}</p>
                {% endif %}
                <a href="#ref-{{ nota.id }}" class="back-to-text">↩ Tornar al text</a>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- Glossari -->
        {% if glossari %}
        <section class="glossary-section" id="glossari">
            <h2>Glossari</h2>
            <dl class="glossary">
                {% for terme in glossari %}
                <div class="glossary-entry" id="term-{{ terme.id }}">
                    <dt>
                        <span class="term-greek">{{ terme.grec }}</span>
                        <span class="term-transliteration">({{ terme.transliteracio }})</span>
                    </dt>
                    <dd>
                        <p class="term-translation"><strong>Traducció:</strong> {{ terme.traduccio }}</p>
                        <p class="term-definition">{{ terme.definicio }}</p>
                        {% if terme.usos %}
                        <p class="term-usage">
                            <strong>Aparicions:</strong>
                            {% for us in terme.usos %}
                            <a href="#trad-{{ us }}">[{{ us }}]</a>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        {% endif %}
                    </dd>
                </div>
                {% endfor %}
            </dl>
        </section>
        {% endif %}

        <!-- Bibliografia -->
        {% if bibliografia %}
        <section class="bibliography-section mt-2xl">
            <h2>Bibliografia</h2>
            {{ bibliografia|safe }}
        </section>
        {% endif %}

        <!-- Navegació -->
        <nav class="work-navigation mt-2xl" aria-label="Navegació entre obres">
            <div style="display: flex; justify-content: center; gap: var(--spacing-xl);">
                <a href="{{ base_url }}index.html" class="badge">← Tornar al catàleg</a>
            </div>
        </nav>
    </div>
</article>

<!-- Script per índex i navegació de capítols -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const tocToggle = document.getElementById('toc-toggle');
    const tocPanel = document.getElementById('chapter-toc');
    const tocClose = document.getElementById('toc-close');
    const tocList = document.getElementById('toc-list');
    const prevBtn = document.getElementById('prev-chapter');
    const nextBtn = document.getElementById('next-chapter');
    const indicator = document.getElementById('chapter-indicator');

    if (!tocToggle || !tocPanel) return;

    // Detectar capítols (h2, strong amb números romans/text, o patrons **I**, **II**, etc.)
    const translationColumn = document.querySelector('.translation-column');
    if (!translationColumn) return;

    const chapters = [];
    const elements = translationColumn.querySelectorAll('h2, h3, p > strong:first-child, p strong:only-child');

    elements.forEach((el, index) => {
        let text = el.textContent.trim();
        // Detectar patrons de capítol: números romans, "Capítol X", números, o títols curts
        const isChapter = /^(I{1,3}|IV|V|VI{0,3}|IX|X{1,3}|XI{0,3}|XIV|XV|XVI{0,3}|XIX|XX|Capítol|Cap\.|Un|Dos|Tres|Quatre|Cinc|Sis|Set|Vuit|Nou|Deu|Onze|Dotze|Tretze|Catorze|Quinze|Setze|Disset|Divuit|Dinou|Vint|\d+)\.?$/i.test(text) ||
                          el.tagName === 'H2' || el.tagName === 'H3';

        if (isChapter && text.length < 50) {
            // Crear id únic
            const id = 'chapter-' + (chapters.length + 1);
            // Assignar ID al paràgraf pare si és un strong dins de p
            const target = el.tagName === 'STRONG' ? el.closest('p') || el : el;
            target.id = id;

            // Afegir a la llista
            chapters.push({
                id: id,
                title: text,
                element: target,
                num: chapters.length + 1
            });
        }
    });

    // Si no hi ha capítols, amagar la navegació
    if (chapters.length <= 1) {
        const nav = document.getElementById('chapter-nav');
        if (nav) nav.style.display = 'none';
        if (tocToggle) tocToggle.style.display = 'none';
        return;
    }

    // Omplir índex
    chapters.forEach((ch, i) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + ch.id;
        a.innerHTML = '<span class="toc-chapter-num">' + ch.num + '.</span> Capítol ' + ch.title;
        a.addEventListener('click', function(e) {
            e.preventDefault();
            scrollToChapter(i);
            closeToc();
        });
        li.appendChild(a);
        tocList.appendChild(li);
    });

    let currentChapter = 0;

    // Funcions
    function updateNavigation() {
        prevBtn.disabled = currentChapter === 0;
        nextBtn.disabled = currentChapter === chapters.length - 1;
        indicator.textContent = 'Capítol ' + (currentChapter + 1) + ' de ' + chapters.length;

        // Actualitzar classe activa a l'índex
        const links = tocList.querySelectorAll('a');
        links.forEach((a, i) => {
            a.classList.toggle('active', i === currentChapter);
        });
    }

    function scrollToChapter(index) {
        if (index < 0 || index >= chapters.length) return;
        currentChapter = index;
        chapters[index].element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        updateNavigation();
    }

    function openToc() {
        tocPanel.classList.add('open');
        tocToggle.setAttribute('aria-expanded', 'true');
    }

    function closeToc() {
        tocPanel.classList.remove('open');
        tocToggle.setAttribute('aria-expanded', 'false');
    }

    function toggleToc() {
        if (tocPanel.classList.contains('open')) {
            closeToc();
        } else {
            openToc();
        }
    }

    // Events
    tocToggle.addEventListener('click', toggleToc);
    tocClose.addEventListener('click', closeToc);

    prevBtn.addEventListener('click', function() {
        scrollToChapter(currentChapter - 1);
    });

    nextBtn.addEventListener('click', function() {
        scrollToChapter(currentChapter + 1);
    });

    // Tancar índex quan es clica fora
    document.addEventListener('click', function(e) {
        if (tocPanel.classList.contains('open') &&
            !tocPanel.contains(e.target) &&
            !tocToggle.contains(e.target)) {
            closeToc();
        }
    });

    // Tecles de navegació
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && tocPanel.classList.contains('open')) {
            closeToc();
        }
        // Fletxes esquerra/dreta per navegar (només si no hi ha focus en input)
        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            if (e.key === 'ArrowLeft' && !prevBtn.disabled) {
                scrollToChapter(currentChapter - 1);
            } else if (e.key === 'ArrowRight' && !nextBtn.disabled) {
                scrollToChapter(currentChapter + 1);
            }
        }
    });

    // Detectar capítol actual al fer scroll
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(function() {
            const scrollPos = window.scrollY + 150;
            for (let i = chapters.length - 1; i >= 0; i--) {
                if (chapters[i].element.offsetTop <= scrollPos) {
                    if (currentChapter !== i) {
                        currentChapter = i;
                        updateNavigation();
                    }
                    break;
                }
            }
        }, 100);
    });

    // Inicialitzar
    updateNavigation();
});
</script>
{% endblock %}
