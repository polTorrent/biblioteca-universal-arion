{% extends "base.html" %}

{% block title %}{{ obra.titol }} - {{ obra.autor }} | Editorial Cl√†ssica{% endblock %}
{% block description %}{{ obra.descripcio|default('Traducci√≥ al catal√† de ' ~ obra.titol ~ ' de ' ~ obra.autor) }}{% endblock %}

{% block og_title %}{{ obra.titol }} - {{ obra.autor }}{% endblock %}
{% block og_description %}{{ obra.descripcio|default('Traducci√≥ al catal√†') }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_url %}/{{ obra.slug }}.html{% endblock %}

{% block head_extra %}
<!-- Estils per √≠ndex, navegaci√≥ i favorits -->
<link rel="stylesheet" href="{{ base_url }}css/obra.css">

<!-- Schema.org -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Book",
    "name": "{{ obra.titol }}",
    "author": {
        "@type": "Person",
        "name": "{{ obra.autor }}"
    },
    "translator": {
        "@type": "Organization",
        "name": "{{ obra.traductor|default('Editorial Cl√†ssica') }}"
    },
    "inLanguage": "ca",
    "workTranslation": {
        "@type": "Book",
        "name": "{{ obra.titol_original }}",
        "author": {
            "@type": "Person",
            "name": "{{ obra.autor_original|default(obra.autor) }}"
        },
        "inLanguage": "{{ obra.llengua_original }}"
    },
    "datePublished": "{{ obra.any_traduccio }}"
}
</script>
{% endblock %}

{% block content %}
<!-- Bot√≥ tornar a dalt -->
<button class="back-to-top" id="back-to-top" title="Tornar a dalt">‚Üë</button>

<article class="page-content">
    <div class="container">
        <!-- Cap√ßalera de l'obra amb portada -->
        <header class="work-header">
            <div class="work-header-content" style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                {% if obra.portada_url %}
                <div style="flex-shrink: 0; text-align: center;">
                    <img src="{{ base_url }}{{ obra.portada_url }}"
                         alt="Portada de {{ obra.titol }}"
                         style="max-width: 200px; height: auto; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <button class="btn-favorit btn-favorit-below"
                            data-obra-id="{{ obra.slug }}"
                            data-obra-titol="{{ obra.titol }}"
                            data-obra-autor="{{ obra.autor }}"
                            title="Afegir a favorits">
                        <span class="favorit-icon">ü§ç</span>
                        <span class="favorit-text">Afegir a favorits</span>
                    </button>
                </div>
                {% endif %}

                <div class="work-info" style="flex: 1; min-width: 300px;">
                    <h1 class="work-title">{{ obra.titol }}</h1>
                    {% if obra.titol_original %}
                    <p class="work-title-original">{{ obra.titol_original }}</p>
                    {% endif %}

                    <div class="work-meta-grid">
                        <div class="work-meta-item">
                            <strong>Autor</strong>
                            {% set autor_slug = obra.autor|lower|replace("'", "")|replace(' ', '-')|replace('(', '')|replace(')', '') %}
                            <a href="{{ base_url }}autor-{{ autor_slug }}.html" class="author-link">{{ obra.autor }}</a>
                            {% if obra.autor_original and obra.autor_original != obra.autor %}
                            <br><small>({{ obra.autor_original }})</small>
                            {% endif %}
                        </div>

                        <div class="work-meta-item">
                            <strong>Traducci√≥</strong>
                            {{ obra.traductor|default('Biblioteca Arion') }}
                        </div>

                        <div class="work-meta-item">
                            <strong>Llengua original</strong>
                            {{ obra.llengua_original|capitalize }}
                        </div>

                        {% if obra.any_original %}
                        <div class="work-meta-item">
                            <strong>Data original</strong>
                            {{ obra.any_original }}
                        </div>
                        {% endif %}

                    </div>

                    {% if obra.descripcio %}
                    <p class="work-description">{{ obra.descripcio }}</p>
                    {% endif %}

                    {% if obra.estat or obra.qualitat %}
                    <!-- Detalls de traducci√≥ (collapsible) -->
                    <button class="details-toggle" id="details-toggle">
                        <span>Detalls de la traducci√≥</span>
                        <span class="toggle-icon">‚ñº</span>
                    </button>
                    <div class="work-details" id="work-details" style="display: none;">
                        <div class="work-meta-grid">
                            {% if obra.estat %}
                            <div class="work-meta-item">
                                <strong>Estat</strong>
                                <span class="badge badge-status-{{ obra.estat }}">{{ obra.estat }}</span>
                            </div>
                            {% endif %}

                            {% if obra.qualitat %}
                            <div class="work-meta-item">
                                <strong>Qualitat</strong>
                                {{ obra.qualitat }}/10
                            </div>
                            {% endif %}

                            {% if obra.seccions %}
                            <div class="work-meta-item">
                                <strong>Cap√≠tols</strong>
                                {{ obra.seccions }}
                            </div>
                            {% endif %}

                            {% if obra.any_traduccio %}
                            <div class="work-meta-item">
                                <strong>Any traducci√≥</strong>
                                {{ obra.any_traduccio }}
                            </div>
                            {% endif %}

                            {% if obra.paraules_original %}
                            <div class="work-meta-item">
                                <strong>Paraules original</strong>
                                {{ obra.paraules_original|default('‚Äî') }}
                            </div>
                            {% endif %}

                            {% if obra.paraules_traduccio %}
                            <div class="work-meta-item">
                                <strong>Paraules traducci√≥</strong>
                                {{ obra.paraules_traduccio|default('‚Äî') }}
                            </div>
                            {% endif %}

                            {% if obra.data_revisio %}
                            <div class="work-meta-item">
                                <strong>√öltima revisi√≥</strong>
                                {{ obra.data_revisio }}
                            </div>
                            {% endif %}

                            {% if obra.font_original %}
                            <div class="work-meta-item">
                                <strong>Font original</strong>
                                {% if obra.font_url %}
                                <a href="{{ obra.font_url }}" target="_blank" rel="noopener">{{ obra.font_original }}</a>
                                {% else %}
                                {{ obra.font_original }}
                                {% endif %}
                            </div>
                            {% endif %}

                            {% if obra.contribuidors %}
                            <div class="work-meta-item" style="grid-column: 1 / -1;">
                                <strong>Contribu√Ødors</strong>
                                <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                                {% for contrib in obra.contribuidors %}
                                    <li>{{ contrib.rol }}: {{ contrib.nom }} ({{ contrib.data }})</li>
                                {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Controls de vista -->
        <div class="text-container" data-mode="bilingue">
            <div class="view-controls">
                <!-- Navegaci√≥ cap√≠tols esquerra -->
                <button class="chapter-nav-top-btn" id="prev-chapter-top" title="Cap√≠tol anterior" disabled>‚Üê</button>

                <button class="view-btn toc-toggle" id="toc-toggle" title="√çndex de cap√≠tols">
                    <span class="toc-icon">‚ò∞</span> √çndex
                </button>
                <span class="view-separator">|</span>
                <button class="view-btn" data-mode="original">Original</button>
                <button class="view-btn active" data-mode="bilingue">Biling√ºe</button>
                <button class="view-btn" data-mode="traduccio">Traducci√≥</button>

                <!-- Navegaci√≥ cap√≠tols dreta -->
                <button class="chapter-nav-top-btn" id="next-chapter-top" title="Cap√≠tol seg√ºent" disabled>‚Üí</button>
            </div>

            <!-- √çndex de cap√≠tols (amagat per defecte) -->
            <nav class="chapter-toc" id="chapter-toc" aria-label="√çndex de cap√≠tols">
                <div class="toc-header">
                    <h3>√çndex de cap√≠tols</h3>
                    <button class="toc-close" id="toc-close" aria-label="Tancar √≠ndex">&times;</button>
                </div>
                <ol class="toc-list" id="toc-list">
                    <!-- Omplert din√†micament per JS -->
                </ol>
            </nav>

            <!-- Grid biling√ºe -->
            <div class="bilingue-grid">
                <!-- Columna original -->
                <section class="original-column">
                    <div class="column-header">Text original ({{ obra.llengua_original }})</div>
                    {{ contingut_original|safe }}
                </section>

                <!-- Columna traducci√≥ -->
                <section class="translation-column">
                    <div class="column-header">Traducci√≥ (catal√†)</div>
                    {{ contingut_traduccio|safe }}
                </section>
            </div>

            <!-- Navegaci√≥ entre cap√≠tols -->
            <nav class="chapter-nav" id="chapter-nav" aria-label="Navegaci√≥ entre cap√≠tols">
                <button class="chapter-nav-btn" id="prev-chapter" disabled>
                    <span class="nav-arrow">‚Üê</span>
                    <span class="nav-text">Cap√≠tol anterior</span>
                </button>
                <span class="chapter-indicator" id="chapter-indicator">Cap√≠tol 1 de 1</span>
                <button class="chapter-nav-btn" id="next-chapter" disabled>
                    <span class="nav-text">Cap√≠tol seg√ºent</span>
                    <span class="nav-arrow">‚Üí</span>
                </button>
            </nav>

            <!-- Botons per mostrar/amagar notes i glossari -->
            {% if notes or glossari %}
            <div class="section-toggle-container">
                {% if glossari %}
                <button class="section-toggle" id="glossari-toggle" data-target="glossari-section">
                    <span>Glossari ({{ glossari|length }})</span>
                    <span class="toggle-icon">‚ñº</span>
                </button>
                {% endif %}
                {% if notes %}
                <button class="section-toggle" id="notes-toggle" data-target="notes-section">
                    <span>Notes ({{ notes|length }})</span>
                    <span class="toggle-icon">‚ñº</span>
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Notes (amagat per defecte) -->
        {% if notes %}
        <section class="notes-section collapsible-section" id="notes-section">
            <h2>Notes</h2>
            {% for nota in notes %}
            <div class="note" id="nota-{{ nota.id }}">
                <div class="note-header">
                    <span class="note-number">[{{ nota.id }}]</span>
                    {% if nota.titol %}
                    <h4>{{ nota.titol }}</h4>
                    {% endif %}
                </div>
                {{ nota.contingut|safe }}
                {% if nota.refs %}
                <p class="note-refs">{{ nota.refs }}</p>
                {% endif %}
                <a href="#" class="back-to-text notes-back">‚Ü© Tornar al text</a>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- Glossari (amagat per defecte) -->
        {% if glossari %}
        <section class="glossary-section collapsible-section" id="glossari-section">
            <h2>Glossari</h2>
            <dl class="glossary">
                {% for terme in glossari %}
                <div class="glossary-entry" id="term-{{ terme.id }}">
                    <dt>
                        <span class="term-greek">{{ terme.grec }}</span>
                        <span class="term-transliteration">({{ terme.transliteracio }})</span>
                    </dt>
                    <dd>
                        <p class="term-translation"><strong>Traducci√≥:</strong> {{ terme.traduccio }}</p>
                        <p class="term-definition">{{ terme.definicio }}</p>
                        <a href="#" class="back-to-text glossary-back">‚Ü© Tornar al text</a>
                    </dd>
                </div>
                {% endfor %}
            </dl>
        </section>
        {% endif %}

        <!-- Bibliografia -->
        {% if bibliografia %}
        <section class="bibliography-section mt-2xl">
            <h2>Bibliografia</h2>
            {{ bibliografia|safe }}
        </section>
        {% endif %}

        <!-- Navegaci√≥ -->
        <nav class="work-navigation mt-2xl" aria-label="Navegaci√≥ entre obres">
            <div style="display: flex; justify-content: center; gap: var(--spacing-xl);">
                <a href="{{ base_url }}index.html" class="badge">‚Üê Tornar al cat√†leg</a>
            </div>
        </nav>
    </div>
</article>

<!-- Script per √≠ndex i navegaci√≥ de cap√≠tols (paginaci√≥) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocToggle = document.getElementById('toc-toggle');
    const tocPanel = document.getElementById('chapter-toc');
    const tocClose = document.getElementById('toc-close');
    const tocList = document.getElementById('toc-list');
    const prevBtn = document.getElementById('prev-chapter');
    const nextBtn = document.getElementById('next-chapter');
    const prevBtnTop = document.getElementById('prev-chapter-top');
    const nextBtnTop = document.getElementById('next-chapter-top');
    const indicator = document.getElementById('chapter-indicator');

    if (!tocToggle || !tocPanel || !tocList) return;

    // IMPORTANT: Netejar la TOC primer per evitar duplicats
    tocList.innerHTML = '';

    // Buscar columnes
    const tradColumn = document.querySelector('.translation-column');
    const origColumn = document.querySelector('.original-column');
    if (!tradColumn) return;

    // Detectar marcadors de cap√≠tol (romans, ar√†bics, o paraules catalanes)
    function isChapterMarker(str) {
        str = str.trim();
        // N√∫meros romans
        if (/^M{0,3}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/i.test(str) && str.length > 0) {
            return true;
        }
        // N√∫meros ar√†bics
        if (/^\d+$/.test(str)) {
            return true;
        }
        // Paraules catalanes de n√∫meros
        var catalanNumbers = ['un', 'dos', 'tres', 'quatre', 'cinc', 'sis', 'set',
                              'vuit', 'nou', 'deu', 'onze', 'dotze', 'tretze',
                              'catorze', 'quinze', 'setze', 'disset', 'divuit',
                              'dinou', 'vint'];
        return catalanNumbers.indexOf(str.toLowerCase()) !== -1;
    }

    // Trobar H2 de cap√≠tols NOM√âS a la columna de traducci√≥
    const allH2s = tradColumn.querySelectorAll('h2');
    const chapters = [];

    allH2s.forEach(function(h2) {
        const text = h2.textContent.trim();
        if (isChapterMarker(text)) {
            chapters.push({ element: h2, title: text });
        }
    });

    // Si no hi ha prou cap√≠tols, amagar TOTA la navegaci√≥ i sortir
    if (chapters.length <= 1) {
        // Amagar navegaci√≥ inferior
        const nav = document.getElementById('chapter-nav');
        if (nav) nav.style.display = 'none';
        // Amagar bot√≥ √≠ndex
        if (tocToggle) tocToggle.style.display = 'none';
        // Amagar panell √≠ndex
        if (tocPanel) tocPanel.style.display = 'none';
        // Amagar botons navegaci√≥ superior
        if (prevBtnTop) prevBtnTop.style.display = 'none';
        if (nextBtnTop) nextBtnTop.style.display = 'none';
        return;
    }

    // Hi ha cap√≠tols: mostrar el bot√≥ d'√≠ndex
    tocToggle.classList.add('visible');

    // Crear entrades de TOC (NOM√âS una vegada per cap√≠tol)
    chapters.forEach(function(ch, i) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.innerHTML = '<span class="toc-chapter-num">' + (i + 1) + '.</span> Cap√≠tol ' + ch.title;
        a.addEventListener('click', function(e) {
            e.preventDefault();
            showChapter(i);
            closeToc();
        });
        li.appendChild(a);
        tocList.appendChild(li);
    });

    let currentChapter = 0;

    // Crear containers per paginaci√≥
    function createContainers(column, chapterList) {
        const h2s = column.querySelectorAll('h2');
        const validH2s = Array.from(h2s).filter(function(h2) {
            return isChapterMarker(h2.textContent.trim());
        });

        validH2s.forEach(function(h2, idx) {
            const container = document.createElement('div');
            container.className = 'chapter-content';
            container.dataset.chapter = idx;
            if (idx > 0) container.style.display = 'none';

            const nodesToMove = [h2];
            let node = h2;
            while (node.nextElementSibling) {
                node = node.nextElementSibling;
                if (node.tagName === 'H2' && validH2s.includes(node)) break;
                nodesToMove.push(node);
            }

            h2.parentNode.insertBefore(container, h2);
            nodesToMove.forEach(function(n) { container.appendChild(n); });
        });
    }

    createContainers(tradColumn, chapters);
    if (origColumn) createContainers(origColumn, chapters);

    function showChapter(index) {
        if (index < 0 || index >= chapters.length) return;
        document.querySelectorAll('.chapter-content').forEach(function(c) {
            c.style.display = 'none';
        });
        document.querySelectorAll('.chapter-content[data-chapter="' + index + '"]').forEach(function(c) {
            c.style.display = 'block';
        });
        currentChapter = index;
        updateNavigation();
        document.querySelector('.text-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateNavigation() {
        const atStart = currentChapter === 0;
        const atEnd = currentChapter === chapters.length - 1;
        prevBtn.disabled = atStart;
        nextBtn.disabled = atEnd;
        if (prevBtnTop) prevBtnTop.disabled = atStart;
        if (nextBtnTop) nextBtnTop.disabled = atEnd;
        indicator.textContent = 'Cap√≠tol ' + (currentChapter + 1) + ' de ' + chapters.length;
        tocList.querySelectorAll('a').forEach(function(a, i) {
            a.classList.toggle('active', i === currentChapter);
        });
    }

    function openToc() { tocPanel.classList.add('open'); }
    function closeToc() { tocPanel.classList.remove('open'); }

    tocToggle.addEventListener('click', function() {
        tocPanel.classList.contains('open') ? closeToc() : openToc();
    });
    tocClose.addEventListener('click', closeToc);
    prevBtn.addEventListener('click', function() { showChapter(currentChapter - 1); });
    nextBtn.addEventListener('click', function() { showChapter(currentChapter + 1); });
    if (prevBtnTop) prevBtnTop.addEventListener('click', function() { showChapter(currentChapter - 1); });
    if (nextBtnTop) nextBtnTop.addEventListener('click', function() { showChapter(currentChapter + 1); });

    document.addEventListener('click', function(e) {
        if (tocPanel.classList.contains('open') && !tocPanel.contains(e.target) && !tocToggle.contains(e.target)) {
            closeToc();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeToc();
        if (e.key === 'ArrowLeft' && !prevBtn.disabled) showChapter(currentChapter - 1);
        if (e.key === 'ArrowRight' && !nextBtn.disabled) showChapter(currentChapter + 1);
    });

    updateNavigation();
});

// Acordi√≥ per detalls de traducci√≥
document.addEventListener('DOMContentLoaded', function() {
    const detailsToggle = document.getElementById('details-toggle');
    const workDetails = document.getElementById('work-details');

    if (detailsToggle && workDetails) {
        detailsToggle.addEventListener('click', function() {
            const isOpen = workDetails.style.display !== 'none';
            workDetails.style.display = isOpen ? 'none' : 'block';
            detailsToggle.classList.toggle('open', !isOpen);
        });
    }
});

// Botons d'acc√©s r√†pid a seccions
document.addEventListener('DOMContentLoaded', function() {
    // Bot√≥ Cap√≠tols - obre l'√≠ndex de cap√≠tols
    const quickChapters = document.getElementById('quick-chapters');
    if (quickChapters) {
        quickChapters.addEventListener('click', function() {
            const tocBtn = document.getElementById('toc-toggle');
            if (tocBtn) tocBtn.click();
        });
    }

    // Bot√≥ Glossari - scroll a la secci√≥ i obre-la
    const quickGlossari = document.getElementById('quick-glossari');
    if (quickGlossari) {
        quickGlossari.addEventListener('click', function() {
            const glossariSection = document.getElementById('glossari-section');
            const glossariToggle = document.getElementById('glossari-toggle');
            if (glossariSection) {
                if (!glossariSection.classList.contains('open')) {
                    glossariSection.classList.add('open');
                    if (glossariToggle) glossariToggle.classList.add('active');
                }
                setTimeout(function() {
                    glossariSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        });
    }

    // Bot√≥ Notes - scroll a la secci√≥ i obre-la
    const quickNotes = document.getElementById('quick-notes');
    if (quickNotes) {
        quickNotes.addEventListener('click', function() {
            const notesSection = document.getElementById('notes-section');
            const notesToggle = document.getElementById('notes-toggle');
            if (notesSection) {
                if (!notesSection.classList.contains('open')) {
                    notesSection.classList.add('open');
                    if (notesToggle) notesToggle.classList.add('active');
                }
                setTimeout(function() {
                    notesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        });
    }
});

// Toggle per seccions collapsibles (glossari i notes)
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.section-toggle');

    toggleButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const targetSection = document.getElementById(targetId);

            if (targetSection) {
                const isOpen = targetSection.classList.contains('open');
                targetSection.classList.toggle('open', !isOpen);
                this.classList.toggle('active', !isOpen);

                // Scroll a la secci√≥ si s'obre
                if (!isOpen) {
                    setTimeout(function() {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }
        });
    });

    // Variable per guardar la posici√≥ de lectura
    var savedScrollPosition = 0;
    var savedTermElement = null;

    // Obrir notes i fer scroll quan es clica una refer√®ncia de nota
    document.querySelectorAll('a.note-ref').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const notesSection = document.getElementById('notes-section');
            const notesToggle = document.getElementById('notes-toggle');
            const targetElement = document.getElementById(targetId);

            // Guardar posici√≥ actual de lectura
            savedScrollPosition = window.scrollY;
            savedTermElement = this;

            // Obrir notes si estan tancades
            if (notesSection && !notesSection.classList.contains('open')) {
                notesSection.classList.add('open');
                if (notesToggle) notesToggle.classList.add('active');
            }

            // Fer scroll a la nota despr√©s d'un petit delay
            if (targetElement) {
                setTimeout(function() {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Ressaltar la nota temporalment (usant classe CSS)
                    targetElement.classList.add('highlight-temp');
                    setTimeout(function() {
                        targetElement.classList.remove('highlight-temp');
                    }, 2000);
                }, 150);
            }
        });
    });

    // Obrir glossari i fer scroll quan es clica un terme
    document.querySelectorAll('a.term').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const glossariSection = document.getElementById('glossari-section');
            const glossariToggle = document.getElementById('glossari-toggle');
            const targetElement = document.getElementById(targetId);

            // Guardar posici√≥ actual de lectura i element clicat
            savedScrollPosition = window.scrollY;
            savedTermElement = this;

            // Obrir glossari si est√† tancat
            if (glossariSection && !glossariSection.classList.contains('open')) {
                glossariSection.classList.add('open');
                if (glossariToggle) glossariToggle.classList.add('active');
            }

            // Fer scroll al terme despr√©s d'un petit delay
            if (targetElement) {
                setTimeout(function() {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Ressaltar el terme temporalment (usant classe CSS)
                    targetElement.classList.add('highlight-temp');
                    setTimeout(function() {
                        targetElement.classList.remove('highlight-temp');
                    }, 2000);
                }, 150);
            }
        });
    });

    // Tornar al text des del glossari (col¬∑lapsar i tornar a la posici√≥)
    document.querySelectorAll('.glossary-back').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const glossariSection = document.getElementById('glossari-section');
            const glossariToggle = document.getElementById('glossari-toggle');

            // Col¬∑lapsar el glossari
            if (glossariSection) {
                glossariSection.classList.remove('open');
            }
            if (glossariToggle) {
                glossariToggle.classList.remove('active');
            }

            // Tornar a la posici√≥ guardada
            setTimeout(function() {
                window.scrollTo({ top: savedScrollPosition, behavior: 'smooth' });
                // Ressaltar breument el terme on est√†vem (usant classe CSS)
                if (savedTermElement) {
                    savedTermElement.classList.add('highlight-temp');
                    setTimeout(function() {
                        savedTermElement.classList.remove('highlight-temp');
                    }, 1500);
                }
            }, 100);
        });
    });

    // Tornar al text des de les notes (col¬∑lapsar i tornar a la posici√≥)
    document.querySelectorAll('.notes-back').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const notesSection = document.getElementById('notes-section');
            const notesToggle = document.getElementById('notes-toggle');

            // Col¬∑lapsar les notes
            if (notesSection) {
                notesSection.classList.remove('open');
            }
            if (notesToggle) {
                notesToggle.classList.remove('active');
            }

            // Tornar a la posici√≥ guardada (o a dalt si no n'hi ha)
            setTimeout(function() {
                if (savedScrollPosition > 0) {
                    window.scrollTo({ top: savedScrollPosition, behavior: 'smooth' });
                } else {
                    document.querySelector('.text-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        });
    });
});

// Inicialitzar estat del bot√≥ de favorits
document.addEventListener('DOMContentLoaded', async function() {
    const favBtn = document.querySelector('.btn-favorit-below');
    if (!favBtn || !window.ArionFavorits) return;

    // Esperar que l'auth estigui llest
    await new Promise(resolve => setTimeout(resolve, 300));

    const obraId = favBtn.dataset.obraId;
    const isFavorit = await window.ArionFavorits.isFavorit(obraId);

    if (isFavorit) {
        favBtn.classList.add('active');
        favBtn.querySelector('.favorit-icon').textContent = '‚ù§Ô∏è';
    }
});

// Bot√≥ tornar a dalt
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('back-to-top');
    if (!backToTop) return;

    function toggleBackToTop() {
        if (window.scrollY > 300) {
            backToTop.classList.add('visible');
        } else {
            backToTop.classList.remove('visible');
        }
    }

    window.addEventListener('scroll', toggleBackToTop);
    toggleBackToTop();

    backToTop.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>
{% endblock %}
