{% extends "base.html" %}

{% block title %}Nova traducci√≥ - Biblioteca Arion{% endblock %}
{% block description %}Proposa una nova traducci√≥ al catal√†.{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ base_url }}css/mecenatge.css">
<style>
.proposta-page {
    max-width: 500px;
    margin: 0 auto;
    padding: var(--spacing-2xl) var(--spacing-lg);
}

.step { display: none; }
.step.active { display: block; }

.step-indicator {
    display: flex;
    justify-content: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-2xl);
}

.step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-border);
    transition: all 0.3s;
}

.step-dot.active { background: var(--color-accent); transform: scale(1.3); }
.step-dot.done { background: var(--mecenatge-success); }

.cerca-box {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
}

.cerca-box input {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: var(--font-size-lg);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-primary);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
}

.cerca-box input:focus {
    outline: none;
    border-color: var(--color-accent);
}

.login-box {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
}

.login-box h3 { margin: 0 0 var(--spacing-lg); text-align: center; border: none; }

.loader {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.analyzing {
    text-align: center;
    padding: var(--spacing-2xl);
}

.analyzing p { margin-top: var(--spacing-md); color: var(--color-text-muted); }

.obra-card {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    text-align: center;
}

.obra-card h3 { margin: 0 0 var(--spacing-xs); font-size: var(--font-size-xl); }
.obra-card .autor { color: var(--color-text-secondary); margin-bottom: var(--spacing-sm); }
.obra-card .meta { font-size: var(--font-size-sm); color: var(--color-text-muted); }

.cost-box {
    background: linear-gradient(135deg, var(--color-bg-tertiary) 0%, var(--color-bg-secondary) 100%);
    border: 2px solid var(--mecenatge-primary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    margin-bottom: var(--spacing-xl);
}

.cost-box .amount {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--mecenatge-primary);
}

.cost-box .detail {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-top: var(--spacing-xs);
}

.finan√ßament-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.finan√ßament-opcio {
    padding: var(--spacing-lg);
    border: 2px solid var(--color-border-light);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.finan√ßament-opcio:hover, .finan√ßament-opcio.selected {
    border-color: var(--mecenatge-primary);
    background: var(--color-bg-secondary);
}

.finan√ßament-opcio .icon { font-size: 1.5rem; }
.finan√ßament-opcio h4 { margin: var(--spacing-sm) 0 0; font-size: 1rem; }

.success-box {
    text-align: center;
    padding: var(--spacing-xl);
}

.success-box .icon { font-size: 3rem; margin-bottom: var(--spacing-md); }
.success-box h2 { color: var(--mecenatge-success); border: none; margin-bottom: var(--spacing-sm); font-size: var(--font-size-2xl); }
</style>
{% endblock %}

{% block content %}
<div class="proposta-page">
    <h1 style="text-align: center; margin-bottom: var(--spacing-xs);">Nova traducci√≥</h1>
    <p style="text-align: center; color: var(--color-text-muted); margin-bottom: var(--spacing-xl);">
        Escriu el t√≠tol i calculem el cost
    </p>

    <div class="step-indicator">
        <span class="step-dot active"></span>
        <span class="step-dot"></span>
        <span class="step-dot"></span>
    </div>

    <!-- STEP 1: T√≠tol -->
    <div class="step active" id="step-1">
        <div class="cerca-box">
            <input type="text" id="titol" placeholder="T√≠tol de l'obra..." autofocus>
            <button class="btn-submit" id="btn-next" disabled>Continuar</button>
        </div>
        <p style="text-align: center; margin-top: var(--spacing-md); color: var(--color-text-muted); font-size: var(--font-size-sm);">
            Ex: La metamorfosi, Faust, Hamlet...
        </p>
    </div>

    <!-- STEP 2: Login -->
    <div class="step" id="step-2">
        <div id="login-section" class="login-box">
            <h3>Entra per continuar</h3>
            <div class="form-group">
                <input type="email" id="email" placeholder="El teu email">
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Contrasenya">
            </div>
            <button class="btn-submit" id="btn-login">Entrar</button>
            <p style="text-align: center; margin-top: var(--spacing-md); font-size: var(--font-size-sm); color: var(--color-text-muted);">
                No tens compte? <a href="registre.html">Registra't</a>
            </p>
        </div>
    </div>

    <!-- STEP 3: Resultat -->
    <div class="step" id="step-3">
        <div id="analyzing" class="analyzing">
            <div class="loader"></div>
            <p>Buscant informaci√≥...</p>
        </div>

        <div id="resultat" style="display: none;">
            <div class="obra-card">
                <h3 id="obra-titol"></h3>
                <p class="autor" id="obra-autor"></p>
                <p class="meta"><span id="obra-idioma"></span> ¬∑ <span id="obra-pagines"></span></p>
            </div>

            <div class="cost-box">
                <div class="amount" id="cost-total"></div>
                <div class="detail" id="cost-detail"></div>
            </div>

            <div class="finan√ßament-grid">
                <div class="finan√ßament-opcio" data-tipus="individual">
                    <div class="icon">üíé</div>
                    <h4>Jo sol/a</h4>
                </div>
                <div class="finan√ßament-opcio" data-tipus="col¬∑lectiu">
                    <div class="icon">üë•</div>
                    <h4>Col¬∑lectiu</h4>
                </div>
            </div>

            <button class="btn-submit" id="btn-confirmar" disabled>Confirmar</button>
        </div>

        <div id="success-section" class="success-box" style="display: none;">
            <div class="icon">‚ú®</div>
            <h2>Proposta enviada!</h2>
            <p id="success-text"></p>
            <a href="mecenatge.html" class="btn-submit" style="display: inline-block; margin-top: var(--spacing-md); text-decoration: none;">
                Veure projectes
            </a>
        </div>
    </div>

    <p style="text-align: center; margin-top: var(--spacing-xl);">
        <a href="mecenatge.html" style="color: var(--color-text-muted);">‚Üê Tornar</a>
    </p>
</div>

<script>
(function() {
    const dots = document.querySelectorAll('.step-dot');
    const titolInput = document.getElementById('titol');
    let obraData = null, costData = null, tipusFinan√ßament = null, currentUser = null;

    const obresDB = {
        'metamorfosi': { titol: 'La metamorfosi', autor: 'Franz Kafka', idioma: 'Alemany', pagines: 60 },
        'princep': { titol: 'El pr√≠ncep', autor: 'Niccol√≤ Machiavelli', idioma: 'Itali√†', pagines: 120 },
        'faust': { titol: 'Faust', autor: 'J.W. von Goethe', idioma: 'Alemany', pagines: 450 },
        'zaratustra': { titol: 'Aix√≠ parl√† Zaratustra', autor: 'Friedrich Nietzsche', idioma: 'Alemany', pagines: 350 },
        'guerra': { titol: 'Guerra i pau', autor: 'Lev Tolstoi', idioma: 'Rus', pagines: 1200 },
        'crim': { titol: 'Crim i c√†stig', autor: 'Fi√≥dor Dostoievski', idioma: 'Rus', pagines: 550 },
        'divina': { titol: 'La Divina Com√®dia', autor: 'Dante Alighieri', idioma: 'Itali√†', pagines: 600 },
        'quixot': { titol: 'Don Quixot', autor: 'Miguel de Cervantes', idioma: 'Castell√†', pagines: 900 },
        'iliada': { titol: 'Il√≠ada', autor: 'Homer', idioma: 'Grec antic', pagines: 500 },
        'odissea': { titol: 'Odissea', autor: 'Homer', idioma: 'Grec antic', pagines: 400 },
        'hamlet': { titol: 'Hamlet', autor: 'William Shakespeare', idioma: 'Angl√®s', pagines: 150 },
        'candide': { titol: 'C√†ndid', autor: 'Voltaire', idioma: 'Franc√®s', pagines: 100 },
        'proces': { titol: 'El proc√©s', autor: 'Franz Kafka', idioma: 'Alemany', pagines: 250 },
        'estranger': { titol: "L'estranger", autor: 'Albert Camus', idioma: 'Franc√®s', pagines: 120 },
        'petit': { titol: 'El petit pr√≠ncep', autor: 'A. de Saint-Exup√©ry', idioma: 'Franc√®s', pagines: 80 }
    };

    function goToStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        dots.forEach((d, i) => { d.classList.remove('active'); if (i < n - 1) d.classList.add('done'); });
        document.getElementById('step-' + n).classList.add('active');
        dots[n - 1].classList.add('active');
    }

    // Step 1: T√≠tol
    titolInput.addEventListener('input', function() {
        document.getElementById('btn-next').disabled = this.value.trim().length < 2;
    });
    titolInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim().length >= 2) document.getElementById('btn-next').click();
    });

    document.getElementById('btn-next').addEventListener('click', function() {
        const user = localStorage.getItem('arion_user');
        if (user) {
            currentUser = JSON.parse(user);
            goToStep(3);
            calcularCost();
        } else {
            goToStep(2);
        }
    });

    // Step 2: Login
    document.getElementById('btn-login').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        if (!email) { alert('Introdueix el teu email'); return; }
        currentUser = { id: 'usr_' + Date.now(), nom: email.split('@')[0], email: email };
        localStorage.setItem('arion_user', JSON.stringify(currentUser));
        goToStep(3);
        calcularCost();
    });

    // Step 3: C√†lcul
    function calcularCost() {
        document.getElementById('analyzing').style.display = 'block';
        document.getElementById('resultat').style.display = 'none';

        setTimeout(function() {
            const query = titolInput.value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            let found = null;
            for (const [key, obra] of Object.entries(obresDB)) {
                if (query.includes(key) || obra.titol.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(query)) {
                    found = obra; break;
                }
            }
            if (!found) {
                const idiomes = ['Angl√®s', 'Franc√®s', 'Alemany', 'Itali√†', 'Rus'];
                found = { titol: titolInput.value.trim(), autor: 'Autor desconegut', idioma: idiomes[Math.floor(Math.random() * idiomes.length)], pagines: Math.floor(Math.random() * 200) + 80 };
            }
            obraData = found;

            const factors = { 'Alemany': 1.2, 'Angl√®s': 0.9, 'Franc√®s': 1.0, 'Itali√†': 1.0, 'Rus': 1.3, 'Grec antic': 1.8, 'Castell√†': 0.8 };
            const cost = Math.round(found.pagines * 0.5 * (factors[found.idioma] || 1.2));
            costData = { total: cost };

            document.getElementById('analyzing').style.display = 'none';
            document.getElementById('resultat').style.display = 'block';
            document.getElementById('obra-titol').textContent = found.titol;
            document.getElementById('obra-autor').textContent = found.autor;
            document.getElementById('obra-idioma').textContent = found.idioma;
            document.getElementById('obra-pagines').textContent = '~' + found.pagines + ' p√†g.';
            document.getElementById('cost-total').textContent = cost + '‚Ç¨';
            document.getElementById('cost-detail').textContent = 'Traducci√≥ completa al catal√†';
        }, 1200);
    }

    // Finan√ßament
    document.querySelectorAll('.finan√ßament-opcio').forEach(o => {
        o.addEventListener('click', function() {
            document.querySelectorAll('.finan√ßament-opcio').forEach(x => x.classList.remove('selected'));
            this.classList.add('selected');
            tipusFinan√ßament = this.dataset.tipus;
            document.getElementById('btn-confirmar').disabled = false;
        });
    });

    // Confirmar
    document.getElementById('btn-confirmar').addEventListener('click', function() {
        const proposta = { id: 'prop_' + Date.now(), ...obraData, cost: costData.total, tipus: tipusFinan√ßament, usuari: currentUser.id, data: new Date().toISOString().split('T')[0] };
        let propostes = JSON.parse(localStorage.getItem('arion_propostes') || '{"propostes":[]}');
        propostes.propostes.push(proposta);
        localStorage.setItem('arion_propostes', JSON.stringify(propostes));

        document.getElementById('resultat').style.display = 'none';
        document.getElementById('success-section').style.display = 'block';
        document.getElementById('success-text').innerHTML = tipusFinan√ßament === 'individual'
            ? `Finan√ßar√†s <strong>${obraData.titol}</strong> per ${costData.total}‚Ç¨.`
            : `Projecte creat per <strong>${obraData.titol}</strong> amb objectiu ${costData.total}‚Ç¨.`;
        dots.forEach(d => d.classList.add('done'));
    });
})();
</script>
{% endblock %}
